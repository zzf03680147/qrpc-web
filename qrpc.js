/*!
 * qrpc.js v0.4.1
 * (c) 2019 innotechx
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).WebIM=t()}(this,function(){"use strict";function m(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function e(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}var u=function(){function a(e){var t=e.flags,n=void 0===t?0:t,i=e.cmd,o=e.payload,r=e.requestID;m(this,a),this.flags=n,this.cmd=i,this.payload=o,this.requestID=r||this.genRequestID()}return e(a,[{key:"encode",value:function(){var e=a.textEncoder.encode(this.payload),t=12+e.length,n=new Uint8Array(t+4);return n[0]=t>>24,n[1]=t>>16,n[2]=t>>8,n[3]=t,n.set(this.requestID,4),n[12]=this.flags,n[13]=this.cmd>>16,n[14]=this.cmd>>8,n[15]=this.cmd,n.set(e,16),n}},{key:"genRequestID",value:function(){for(;;){var e=new Uint32Array(2);e[0]=Math.floor(Math.random()*(Math.pow(2,32)-1)),e[1]=Math.floor(Math.random()*(Math.pow(2,32)-1));var t=new Uint8Array(e.buffer);if(!a.requestIDCached[t])return a.requestIDCached[t]=!0,t}}},{key:"genHexRequestID",value:function(){return Array.from(this.requestID).map(function(e){return e.toString(16)}).join("")}}],[{key:"decode",value:function(e){var t=new Uint8Array(e),n=(t[0]<<24)+(t[1]<<16)+(t[2]<<8)+t[3],i=t.subarray(4,12),o=t[12],r=(t[13]<<16)+(t[14]<<8)+t[15],s=t.subarray(16,n+4),u=o.toString(2);return s="1"===u.charAt(u.length-6)?a.unzipAdapter(s):a.textDecoder.decode(s),new a({flags:o,cmd:r,payload:s,requestID:i})}},{key:"unzipAdapter",get:function(){return a._unzipAdapter},set:function(e){a._unzipAdapter=e}}]),a}();u.textEncoder=new TextEncoder("utf-8"),u.textDecoder=new TextDecoder("utf-8"),u._unzipAdapter=function(e){return e},u.requestIDCached={};function p(){}var t=function(){function r(e){var t=e.dialTimeout,n=void 0===t?1e3:t,i=e.requestTimeout,o=void 0===i?2e3:i;m(this,r),this._dialTimeout=n,this._requestTimeout=o}return e(r,[{key:"dialTimeout",get:function(){return this._dialTimeout}},{key:"DialTimeout",set:function(e){this._dialTimeout=e}},{key:"requestTimeout",get:function(){return this._requestTimeout},set:function(e){this._requestTimeout=e}}]),r}(),a=function(){function t(e){var n=this;m(this,t),this._promise=new Promise(function(e,t){n._resolve=e,n._reject=t}),0<e&&(this._id=setTimeout(function(){n._reject("timeout")},e))}return e(t,[{key:"getPromise",value:function(){return this._promise}},{key:"success",value:function(e){this._resolve(e),this._complete()}},{key:"fail",value:function(e){this._reject(e),this._complete()}},{key:"_complete",value:function(){this._id&&(clearTimeout(this._id),this._id=null)}}]),t}(),n=function(){function l(e){var t=e.conf,n=e.addr,i=e.onopen,o=void 0===i?p:i,r=e.onclose,s=void 0===r?p:r,u=e.onerror,a=void 0===u?p:u,c=e.onmessage,f=void 0===c?p:c,h=e.onrequest,d=void 0===h?p:h;m(this,l),this.conf=t,this.respCache={},this.addr=n,this.onopen=o,this.onclose=s,this.onerror=a,this.onmessage=f,this.onrequest=d}return e(l,[{key:"connect",value:function(){var n=this,t=new a,e=new WebSocket(this.addr,null,{handshakeTimeout:this.conf.dialTimeout});return(this.ws=e).binaryType="arraybuffer",e.onclose=function(e){n.onclose(e)},e.onopen=function(e){n.onopen(e),t.success(e)},e.onerror=function(e){n.onerror(e),t.fail(e)},e.onmessage=function(e){if("string"!=typeof e.data){n.onmessage(e);var t=u.decode(e.data);t.requestID in n.respCache&&(n.respCache[t.requestID].success(t),delete n.respCache[t.requestID])}},t.getPromise()}},{key:"request",value:function(e){var t=e.cmd,n=e.payload,i=e.flags,o=new u({cmd:t,payload:n,flags:void 0===i?0:i}),r=o.encode();this.ws.send(r),this.onmessage(r);var s=o.requestID;return this.respCache[s]=new a(this.conf.requestTimeout),this.respCache[s].getPromise()}},{key:"close",value:function(){if(this.ws&&this.ws.readyState===WebSocket.OPEN){for(var e in this.ws.close(),this.ws=null,this.respCache)this.respCache[e].fail("server closed");this.respCache={}}}}]),l}();return{Frame:u,Config:t,Completer:a,Client:n}});
